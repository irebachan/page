<!DOCTYPE html>
<html lang="ja">

<head>
    <meta charset="UTF-8">
    <title>ãƒãƒ™ãƒ«è©¦ä½œãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼</title>
    <style>
        body {
            display: flex;
            background: #000;
            color: #fff;
            font-family: sans-serif;
            height: 100vh;
            margin: 0;
        }

        /* å·¦å´ã®ãƒãƒ™ãƒ«ãƒ“ãƒ¥ãƒ¼ã‚¢ */
        .novel-viewer {
            flex: 1;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: flex-start;
            padding: 2em;
            border-right: 2px solid #fff;
            color: #fff;
        }

        .name {
            font-weight: bold;
            color: #9cf;
            margin-bottom: .5em;
        }

        .text {
            margin-bottom: 2em;
            white-space: pre-wrap;
            text-align: left;
        }

        .choices button {
            display: block;
            margin: .5em 0;
            font-size: 1em;
            width: 100%;
        }

        #next,
        #restart {
            font-size: 1.2em;
            width: 100%;
        }

        /* å³å´: ã‚·ãƒŠãƒªã‚ªãƒ†ã‚­ã‚¹ãƒˆãƒœãƒƒã‚¯ã‚¹ (ç·¨é›†å¯) */
        .scenario-box {
            flex: 1;
            padding: 2em;
            background: #222;
        }

        #scriptText {
            width: 100%;
            height: 100%;
            color: #fff;
            background: #333;
            border: 1px solid #444;
            padding: 1em;
            font-family: monospace;
            font-size: 1.1em;
            white-space: pre-wrap;
            resize: none;
            overflow: auto;
        }
    </style>
</head>

<body>
    <!-- å·¦å´: ãƒãƒ™ãƒ«ãƒ“ãƒ¥ãƒ¼ã‚¢ -->
    <div class="novel-viewer">
        <div class="name" id="name"></div>
        <div class="text" id="text"></div>
        <div class="choices" id="choices"></div>
        <button id="next">â–¶ æ¬¡ã¸</button>
        <button id="restart" style="display: none;">ğŸ”„ æœ€åˆã«æˆ»ã‚‹</button>
    </div>

    <!-- å³å´: ã‚·ãƒŠãƒªã‚ªè¡¨ç¤º (ç·¨é›†å¯èƒ½ãƒ†ã‚­ã‚¹ãƒˆãƒœãƒƒã‚¯ã‚¹) -->
    <div class="scenario-box">
        <textarea id="scriptText" oninput="updateScript()"></textarea>
    </div>

    <script>
        // ã‚·ãƒŠãƒªã‚ªã®è§£æé–¢æ•°
        function parseScript(rawScript) {
            const lines = rawScript.trim().split("\n");
            let script = [];
            let labels = {};
            let i = 0;

            while (i < lines.length) {
                let line = lines[i].trim();
                if (line === "") { i++; continue; }

                if (line.startsWith("@label")) {
                    const labelName = line.split(" ")[1];
                    labels[labelName] = script.length;
                    i++;
                } else if (line === "*choice") {
                    i++;
                    let choices = [];
                    while (i < lines.length && lines[i].startsWith("-")) {
                        let [text, target] = lines[i].slice(1).split("=>").map(s => s.trim());
                        choices.push({ text, target });
                        i++;
                    }
                    script.push({ type: "choice", choices });
                } else if (line.startsWith("#")) {
                    const name = line.slice(1);
                    const text = lines[++i];
                    script.push({ type: "line", name, text });
                    i++;
                } else if (line === "@end") {
                    script.push({ type: "end" });
                    i++;
                } else {
                    i++;
                }
            }
            return { script, labels };
        }

        // åˆæœŸã‚¹ã‚¯ãƒªãƒ—ãƒˆ
        let rawScript = `
#ãƒ¦ã‚¦
ãŠã¯ã‚ˆã†ã€‚ä»Šæ—¥ã¯ã„ã„å¤©æ°—ã ã­ã€‚

*choice
- å…¬åœ’ã«è¡Œã => park
- å›³æ›¸é¤¨ã«è¡Œã => library

@label park
#ãƒ¦ã‚¦
å…¬åœ’ã¯é™ã‹ã§ã„ã„ãªã‚ã€‚

#ãƒŸãƒŠ
ã»ã‚‰ã€é³©ãŒé›†ã¾ã£ã¦ã‚‹ã‚ˆã€‚

@end

@label library
#ãƒ¦ã‚¦
æœ¬ã£ã¦è½ã¡ç€ãã‚ˆã­ã€‚

#ãƒŸãƒŠ
ä»Šæ—¥ã®æ–°åˆŠã¯ãªã‚“ã ã‚ã†ã€‚

@end
`;

        let { script, labels } = parseScript(rawScript);
        let index = 0;

        const nameBox = document.getElementById("name");
        const textBox = document.getElementById("text");
        const nextBtn = document.getElementById("next");
        const choicesBox = document.getElementById("choices");
        const scriptTextBox = document.getElementById("scriptText");
        const restartBtn = document.getElementById("restart");

        // åˆæœŸã‚¹ã‚¯ãƒªãƒ—ãƒˆã‚’ãƒ†ã‚­ã‚¹ãƒˆã‚¨ãƒªã‚¢ã«è¡¨ç¤º
        scriptTextBox.value = rawScript.trim();

        // ã‚·ãƒŠãƒªã‚ªã®è¡¨ç¤º
        function showLine() {
            const line = script[index];
            if (!line) {
                // çµ‚äº†ã—ãŸã‚‰æœ€åˆã«æˆ»ã‚‹
                restartBtn.style.display = "inline"; // ã€Œæœ€åˆã«æˆ»ã‚‹ã€ãƒœã‚¿ãƒ³ã‚’è¡¨ç¤º
                nextBtn.style.display = "none"; // ã€Œæ¬¡ã¸ã€ãƒœã‚¿ãƒ³ã‚’éš ã™
                return;
            }

            if (line.type === "line") {
                nameBox.textContent = line.name;
                textBox.textContent = line.text;
                nextBtn.style.display = "inline";
                choicesBox.innerHTML = "";
                restartBtn.style.display = "none"; // çµ‚äº†å‰ã¯ã€Œæœ€åˆã«æˆ»ã‚‹ã€ãƒœã‚¿ãƒ³ã‚’éš ã™
                index++;
            } else if (line.type === "choice") {
                nextBtn.style.display = "none";
                nameBox.textContent = "";
                textBox.textContent = "";
                choicesBox.innerHTML = "";
                line.choices.forEach(choice => {
                    const btn = document.createElement("button");
                    btn.textContent = choice.text;
                    btn.onclick = () => {
                        index = labels[choice.target] ?? index;
                        showLine();
                    };
                    choicesBox.appendChild(btn);
                });
            } else if (line.type === "end") {
                nameBox.textContent = "";
                textBox.textContent = "ï¼ˆçµ‚ã‚ã‚Šï¼‰";
                nextBtn.style.display = "none";
                choicesBox.innerHTML = "";
                restartBtn.style.display = "inline"; // çµ‚äº†å¾Œã«æœ€åˆã«æˆ»ã‚‹ãƒœã‚¿ãƒ³è¡¨ç¤º
            }
        }

        // æ¬¡ã¸ãƒœã‚¿ãƒ³ãŒæŠ¼ã•ã‚ŒãŸã¨ã
        nextBtn.addEventListener("click", showLine);

        // æœ€åˆã«æˆ»ã‚‹ãƒœã‚¿ãƒ³ãŒæŠ¼ã•ã‚ŒãŸã¨ã
        restartBtn.addEventListener("click", function () {
            index = 0; // ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã‚’0ã«æˆ»ã™
            showLine(); // æœ€åˆã‹ã‚‰ã‚·ãƒŠãƒªã‚ªã‚’è¡¨ç¤º
        });

        // ã‚·ãƒŠãƒªã‚ªã‚’æ›´æ–° (ãƒ†ã‚­ã‚¹ãƒˆã‚¨ãƒªã‚¢ã§ã®å…¥åŠ›ã«ã‚ˆã‚‹æ›´æ–°)
        function updateScript() {
            rawScript = scriptTextBox.value;
            ({ script, labels } = parseScript(rawScript));  // æ–°ã—ã„ã‚¹ã‚¯ãƒªãƒ—ãƒˆã«åŸºã¥ã„ã¦è§£æ
            index = 0;  // ã‚¹ã‚¯ãƒªãƒ—ãƒˆã‚’å†è§£æã—ãŸã‚‰ã€ã‚·ãƒŠãƒªã‚ªã¯æœ€åˆã«æˆ»ã™
            showLine();
        }

        showLine();  // åˆå›è¡¨ç¤º
    </script>
</body>

</html>